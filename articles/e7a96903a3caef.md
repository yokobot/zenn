---
title: "Aurora MySQLã®slow queryã‚’New Relicã§ã„ã„æ„Ÿã˜ã«ãƒ—ãƒ­ãƒƒãƒˆã™ã‚‹æ–¹æ³•"
emoji: "ğŸ“Š"
type: "tech"
topics:
  - "aws"
  - "mysql"
  - "aurora"
  - "newrelic"
  - "slowquery"
published: false
---

## æ¦‚è¦
  - NRQLã£ã¦SQLãƒ©ã‚¤ã‚¯ã§æ›¸ãã‚„ã™ã„ã‚“ã§ã™ãŒã€ãƒ­ã‚°å‘¨ã‚Šã§å–ã‚ŠãŸã„æ–‡å­—åˆ—ãŒå–ã‚Œãªãã¦ãƒãƒã£ãŸã‚Šã—ã¾ã›ã‚“ã‹ï¼Ÿ
  - ãã‚“ãªæ™‚ã¯captureé–¢æ•°ã‚’ä½¿ãˆã°æ­£è¦è¡¨ç¾ã§ç›®çš„ã®æ–‡å­—åˆ—ãŒã•ãã£ã¨å–å¾—ã§ãã¾ã™ã€‚
  - captureé–¢æ•°ã§Aurora MySQLã®slow logã‚’ã‚¯ã‚¨ãƒªæ¯ã«ç©ã¿ä¸Šã’æ£’ã‚°ãƒ©ãƒ•ã§ãƒ—ãƒ­ãƒƒãƒˆã™ã‚‹è¨˜äº‹ã§ã™ã€‚

![ã‚°ãƒ©ãƒ•](https://storage.googleapis.com/zenn-user-upload/da151eb0cdcb-20230722.png)

## ã‚¹ãƒ­ãƒ¼ã‚¯ã‚¨ãƒªã®è»¢é€æ–¹æ³•
æœ€åˆã«CloudWatch Logsã«å‡ºåŠ›ã•ã‚ŒãŸAurora MySQLã®ã‚¹ãƒ­ãƒ¼ã‚¯ã‚¨ãƒªã‚’New Relicã«è»¢é€ã—ã¾ã™ã€‚
ä»¥ä¸‹ã®ã‚ˆã†ã«AWSãƒãƒãƒ¼ã‚¸ãƒ‰ã‚µãƒ¼ãƒ“ã‚¹ã‚’ç¹‹ãã¾ã™ã€‚

![æ§‹æˆå›³](https://storage.googleapis.com/zenn-user-upload/0238775bbf72-20230722.png)

ã“ã®è¨˜äº‹ã¯NRQLãƒ¡ã‚¤ãƒ³ãªã®ã§è©³ã—ã„è¨­å®šæ‰‹é †ã¯ãªã—ã«ã—ã¦ã€å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã®ãƒªãƒ³ã‚¯ã‚’è¨˜è¼‰ã—ã¾ã™ã€‚æ˜”ã¯lambdaã‚’ç”¨æ„ã™ã‚‹å¿…è¦ãŒã‚ã£ãŸã®ã§ã™ãŒã€kinesis Firehoseã ã‘ã§è‰¯ããªã£ãŸã®ã§æ§‹ç¯‰ãŒæ¥½ã«ãªã‚Šã¾ã—ãŸã€‚

[Kinesis Data Firehoseã«ã‚ˆã‚‹ãƒ­ã‚°ã®ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°](https://docs.newrelic.com/jp/docs/logs/forward-logs/stream-logs-using-kinesis-data-firehose/)


## è»¢é€ã•ã‚ŒãŸã‚¹ãƒ­ãƒ¼ã‚¯ã‚¨ãƒªã¯ã©ã“ã«ï¼Ÿ
New Relic Logsã«ä»¥ä¸‹ã®å½¢å¼ã§è»¢é€ã•ã‚Œã¾ã™ã€‚

    logGroup = '/aws/rds/cluster/{Aurora cluster name}/slowquery'

![message](https://storage.googleapis.com/zenn-user-upload/d9295cc95667-20230722.png)

```
[message]

# Time: 2023-07-22T02:10:17.177218Z
# User@Host: hoge @  [xx.x.x.xx]  Id: 6235867
# Query_time: 12.771031  Lock_time: 0.000095 Rows_sent: 0  Rows_examined: 267739
use fuga;
SET timestamp=1689991817;
update 
		piyo 
	set 
		hoge = 1
	where 
		fuga = 1 and 
		piyo = 0 and 
		date < unix_timestamp() and 
		flg = 0;
```

ã¡ã‚ƒã‚“ã¨è»¢é€ã•ã‚Œã¦ãã¦ã„ã¾ã™ãŒã“ã®ã¾ã¾ã§ã¯ã¡ã‚‡ã£ã¨ã‚°ãƒ©ãƒ•ã«ã—è¾›ã„ã§ã™ã€‚ä½•ã¨ã‹ã—ã¦ã‚¯ã‚¨ãƒªã®ã¿ã«ã—ãŸã„ã€‚ã€‚

## captureé–¢æ•°ã®å‡ºç•ª
NRQLã§ç”¨æ„ã•ã‚Œã¦ã„ã‚‹[captureé–¢æ•°](https://docs.newrelic.com/whats-new/2021/06/extract-data-regex/)ã‚’ä½¿ã£ã¦ã‚¯ã‚¨ãƒªã®ã¿ã‚’æŠ½å‡ºã—ã¾ã™ã€‚
æ­£è¦è¡¨ç¾ã§æ–‡å­—åˆ—ã‚’æŠ½å‡ºã§ãã‚‹ã®ã§ã€ä»Šå›ã®ã‚ˆã†ãªè¤‡æ•°è¡Œã®ãƒ­ã‚°ã‹ã‚‰ä¸€éƒ¨åˆ†ã‚’æŠœãå‡ºã™ã®ã«éå¸¸ã«ä¾¿åˆ©ã§ã™ã€‚

ä»Šå›ã‚„ã‚ŠãŸã„ã“ã¨ã¯ã€

- ä¸€é€±é–“ã§ã‚¯ã‚¨ãƒªç¨®åˆ¥æ¯ã«å‡ºç¾ã—ãŸå›æ•°ã‚’ç©ã¿ä¸Šã’æ£’ã‚°ãƒ©ãƒ•ã§ãƒ—ãƒ­ãƒƒãƒˆã™ã‚‹

ãªã®ã§ã‚°ãƒ«ãƒ¼ãƒ”ãƒ³ã‚°ã™ã‚‹ `FACET` å¥ã§captureé–¢æ•°ã‚’ä½¿ãˆã°ã‚ˆã•ãã†ã§ã™ã€‚

```
SELECT count(*) FROM Log WHERE `logGroup` = '/aws/rds/cluster/my-aurora-cluster/slowquery' FACET {ã“ã“ã§ã‚´ãƒ‹ãƒ§ã‚´ãƒ‹ãƒ§ã™ã‚‹} TIMESERIES SINCE 1 week ago
```

### å®Ÿéš›ã®æ›¸ãæ–¹

messageã®æ§‹é€ ã¯ä»¥ä¸‹ã®ã‚ˆã†ã«ãªã£ã¦ã„ã¾ã™ã€‚

```
# Time: 2023-07-22T02:10:17.177218Z
# User@Host: hoge @  [xx.x.x.xx]  Id: 6235867
# Query_time: 12.771031  Lock_time: 0.000095 Rows_sent: 0  Rows_examined: 267739
use fuga;
SET timestamp=1689991817;
update 
		piyo 
	set 
		hoge = 1
	where 
		fuga = 1 and 
		piyo = 0 and 
		date < unix_timestamp() and 
		flg = 0;
```

æ›¸å¼ã¯ `cature({ã‚´ãƒ‹ãƒ§ã‚´ãƒ‹ãƒ§ã™ã‚‹å¯¾è±¡}, {æ­£è¦è¡¨ç¾ãƒ‘ã‚¿ãƒ¼ãƒ³})` ãªã®ã§ã€ã¾ãšã¯ã“ã®ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

```
capture(message, {æ­£è¦è¡¨ç¾ãƒ‘ã‚¿ãƒ¼ãƒ³})
```

æ­£è¦è¡¨ç¾ãƒ‘ã‚¿ãƒ¼ãƒ³ã«ã¡ã‚‡ã£ã¨ç™–ãŒã‚ã‚Šã€åå‰ä»˜ãã®ã‚­ãƒ£ãƒ—ãƒãƒ£ã‚°ãƒ«ãƒ¼ãƒ—ã‚’æŒ‡å®šã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

```
capture(message, r'{æ­£è¦è¡¨ç¾}(?P<{ã‚­ãƒ£ãƒ—ãƒãƒ£ã‚°ãƒ«ãƒ¼ãƒ—å}>{æ­£è¦è¡¨ç¾}){æ­£è¦è¡¨ç¾}')

[ä¾‹]
capture(request_url, r'.*/accounts/(?P<account>\d+).*')

-> request_urlã‹ã‚‰ã€~/accounts/xxxxxxxx/~ã®xxxxxxxxã‚’æŠ½å‡ºã™ã‚‹ï¼ˆxxxxxxxxã¯æ•°å­—ã®ã¿ã§æ§‹æˆï¼‰ã€æŠ½å‡ºã™ã‚‹ã‚­ãƒ£ãƒ—ãƒãƒ£ã‚°ãƒ«ãƒ¼ãƒ—åã¯accountã€‚
```

ä»Šå›ã¯ `SET timestamp=1689991817;` ä»¥é™ã®æ–‡å­—åˆ—ã‚’å–å¾—ã—ãŸã„ã®ã§ã€

- SET timestamp=xxxxxxxxx; ã¾ã§ã¯å…¨éƒ¨ç„¡è¦–
- ä»¥é™ã®æ–‡å­—åˆ—ã‚’å…¨ã¦å–å¾—ã™ã‚‹

ã¨ãªã‚‹ã®ã§ã€ä»¥ä¸‹ã®ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

```
capture(message, r'[\s\S]*SET timestamp=\d+;(?P<sql>.*)')

-> ã‚­ãƒ£ãƒ—ãƒãƒ£ã‚°ãƒ«ãƒ¼ãƒ—åã¯sqlä»¥å¤–ã§ã‚‚ã‚ˆã„
```

## å®Œæˆã—ãŸNRQL
    SELECT count(*) FROM Log WHERE `logGroup` = '/aws/rds/cluster/my-aurora-cluster/slowquery' FACET capture(message, r'[\s\S]*SET timestamp=\d+;(?P<sql>.*)') TIMESERIES SINCE 1 week ago

## æœ€å¾Œã«
NRQLã¯è‡ªåˆ†ã®æœ›ã‚€ã‚ˆã†ã«ãƒ‡ãƒ¼ã‚¿ã‚’å‡ºåŠ›ã§ãã‚‹ã€ã¨ã¦ã‚‚å¼·åŠ›ãªãƒ„ãƒ¼ãƒ«ã§ã™ã€‚
ã‚­ãƒ£ãƒ—ãƒãƒ£ã‚°ãƒ«ãƒ¼ãƒ—ã®ã¨ã“ã‚ã§ã¡ã‚‡ã£ã¨è‹¦åŠ´ã—ãŸã®ã§å‚è€ƒã«ãªã‚Œã°ã¨æ€ã„è¨˜äº‹ã«ã—ã¾ã—ãŸã€‚
ãã‚Œã§ã¯ç´ æ•µãª[New Relic](https://newrelic.com/jp/about/media-assets#:~:text=EPS%C2%A0%20%C2%A0SVG-,New%20Relic%E3%81%AE%E8%A1%A8%E8%A8%98%E3%81%AB%E3%81%A4%E3%81%84%E3%81%A6,-%E3%80%8CNew%20Relic%E3%80%8D%E3%81%AE)ãƒ©ã‚¤ãƒ•ã‚’ï¼

## å‚è€ƒ
[captureé–¢æ•°ã®å…¬å¼ãƒ–ãƒ­ã‚°](https://newrelic.com/jp/blog/how-to-relic/nrql-regrex-capture)


